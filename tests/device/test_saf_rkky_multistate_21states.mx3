// Same as before but with 21 states
SetGridSize(16, 16, 4)
SetCellSize(5e-9, 5e-9, 2e-9)

DefRegion(0, Layer(0).Add(Layer(1)))
DefRegion(1, Layer(2).Add(Layer(3)))

EnableSAF()
SetSAFLayers(0, 1)
J_RKKY = -2e-3

ApplyMaterial(0, "CoFeB")
ApplyMaterial(1, "CoFeB")

alpha = 0.1
MaxErr = 1e-4
MinDt = 1e-15
MaxDt = 1e-12

m.setRegion(0, uniform(0, 0, 1))
m.setRegion(1, uniform(0, 0, 1))

print("=== SAF-RKKY 21-State Test ===")
print("State,Bx,By,Angle,Energy,E_kT,Weight,Delta_theta")

N_states := 21  // INCREASED TO 21
min_angle_sep := 180.0
max_angle_sep := 0.0
prev_angle := 0.0

for i := 0; i < N_states; i = i + 1 {
    theta := i * pi / (N_states - 1)
    Bx := 0.02 * cos(theta)
    By := 0.02 * sin(theta)
    
    B_ext = vector(Bx, By, 0)
    relax()
    
    mx0 := m.Region(0).average()[0]
    my0 := m.Region(0).average()[1]
    mz0 := m.Region(0).average()[2]
    
    mx1 := m.Region(1).average()[0]
    my1 := m.Region(1).average()[1]
    mz1 := m.Region(1).average()[2]
    
    dot_product := mx0*mx1 + my0*my1 + mz0*mz1
    if dot_product > 1.0 {
        dot_product = 1.0
    }
    if dot_product < -1.0 {
        dot_product = -1.0
    }
    
    angle := acos(dot_product) * 180.0 / pi
    E_rkky := SAFEnergy()
    kT := 1.38e-23 * 300.0
    E_kT := E_rkky / kT
    weight := cos(angle * pi / 180.0)
    
    delta_theta := 0.0
    if i > 0 {
        delta_theta = angle - prev_angle
        angle_sep := abs(delta_theta)
        if angle_sep < min_angle_sep {
            min_angle_sep = angle_sep
        }
        if angle_sep > max_angle_sep {
            max_angle_sep = angle_sep
        }
    }
    
    print(sprintf("%d,%.6e,%.6e,%.2f,%.6e,%.2f,%+.4f,%.2f",
                  i, Bx, By, angle, E_rkky, E_kT, weight, delta_theta))
    
    prev_angle = angle
}

print("")
print(sprintf("Minimum separation: %.2f deg", min_angle_sep))
print(sprintf("Maximum separation: %.2f deg", max_angle_sep))
print(sprintf("Average separation: %.2f deg", 180.0 / (N_states - 1)))

save(m)
